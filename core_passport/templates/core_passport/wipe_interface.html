<!-- templates/core_passport/wipe_interface.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Universal Secure Wipe Portal</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 50px auto; text-align: center; background-color: #f0f4f7; }
        .container { background-color: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 30px; }
        h1 { color: #2196f3; }
        label { display: block; margin-top: 15px; font-weight: bold; text-align: left; margin-left: 20px; }
        select, button, .checkbox-group { padding: 10px; margin: 8px 0; font-size: 1em; border-radius: 5px; width: calc(100% - 20px); box-sizing: border-box; }
        .checkbox-group { text-align: left; border: 1px solid #ccc; padding: 15px; background-color: #f9f9f9; }
        .checkbox-group input { margin-right: 10px; }
        .checkbox-group label { margin-left: 0; font-weight: normal; display: inline-block; }
        button { border: none; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #btn-delete { background-color: #f44336; color: white; } 
        #btn-delete:hover { background-color: #d32f2f; }
        #btn-certify { background-color: #4caf50; color: white; }
        #btn-certify:hover { background-color: #388e3c; }
        #btn-certify:disabled { background-color: #ccc; cursor: not-allowed; }
        .output { border: 1px solid #ccc; padding: 15px; margin-top: 20px; text-align: left; background-color: #eee; white-space: pre-wrap; height: 150px; overflow-y: scroll; border-radius: 5px; font-size: 0.9em; }
        .algorithm-info { font-size: 0.9em; margin-top: 5px; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Universal Secure Wipe Portal</h1>
        <p>This panel controls the two-step secure erasure on the target device (IP: **{{ kali_ip }}**).</p>
        <hr>

        <!-- Drive Selection -->
        <label for="drive-select">1. Select Target Drive/Partition (Physical Target):</label>
        <select id="drive-select">
            {% for drive in simulated_drives %}
                <option value="{{ drive.id }}">{{ drive.name }}</option>
            {% endfor %}
        </select>
        <div class="algorithm-info">
            *Always select the drive containing the operating system you wish to prepare for reuse.*
        </div>

        <!-- Folder Selection (For Step 1 Deletion) -->
        <label>2. Select Folders for Permanent Deletion (Step 1 Preparation):</label>
        <div class="checkbox-group">
            {% for folder in simulated_folders %}
                <div>
                    <input type="checkbox" id="folder-{{ folder.path }}" name="folders" value="{{ folder.path }}" checked>
                    <label for="folder-{{ folder.path }}">{{ folder.name }}</label>
                </div>
            {% endfor %}
            <div class="algorithm-info">
                *File deletion marks the space as 'empty', but leaves residue. Residue is destroyed in Step 2.*
            </div>
        </div>

        <button id="btn-delete" onclick="step1_deleteFiles()">STEP 1: Delete Selected Files Permanently</button>
        <hr>
        
        <!-- Algorithm Selection (For Step 2 Wipe) -->
        <label for="algo-select">3. Select Wiping Algorithm (Security Level):</label>
        <select id="algo-select" onchange="updateAlgorithmInfo()">
            {% for key, algo in wipe_algorithms.items %}
                <option value="{{ key }}" 
                    data-passes="{{ algo.passes }}" 
                    data-desc="{{ algo.description }}"
                    {% if key == 'NIST' %}selected{% endif %}>
                    {{ algo.name }}
                </option>
            {% endfor %}
        </select>
        <div class="algorithm-info" id="algo-info"></div>

        <button id="btn-certify" onclick="step2_wipeFreeSpace()" disabled>STEP 2: Wipe Free Space & Mint Passport</button>

        <div class="output" id="output">Status: Ready.</div>
    </div>

    <script>
        const API_MINT_URL = "http://127.0.0.1:8000{{ api_mint_url }}";
        const API_DELETE_URL = "http://127.0.0.1:8000{{ api_delete_url }}";
        const DEVICE_ID = "UNIVERSAL-" + new Date().getTime(); 
        const KALI_USER_DIR = "{{ kali_user_dir }}"; 

        document.addEventListener('DOMContentLoaded', updateAlgorithmInfo);

        function log(message) {
            const outputElement = document.getElementById('output');
            outputElement.innerHTML += `<br> ${message}`;
            outputElement.scrollTop = outputElement.scrollHeight; // Auto-scroll
        }

        function updateAlgorithmInfo() {
            const select = document.getElementById('algo-select');
            const selectedOption = select.options[select.selectedIndex];
            const passes = selectedOption.getAttribute('data-passes');
            const desc = selectedOption.getAttribute('data-desc');
            document.getElementById('algo-info').innerHTML = `<strong>Passes:</strong> ${passes} <br>${desc}`;
        }

        // --- STEP 1: DELETION (Functional API Call) ---
        function step1_deleteFiles() {
            const checkedFolders = Array.from(document.querySelectorAll('input[name="folders"]:checked'))
                .map(cb => cb.value);

            if (checkedFolders.length === 0) {
                log("⚠️ WARNING: No folders selected. Proceeding directly to Step 2 will only wipe existing residue.");
                document.getElementById('btn-certify').disabled = false;
                document.getElementById('btn-delete').disabled = true;
                return;
            }

            if (!confirm(`WARNING: This will permanently delete files in: ${checkedFolders.join(', ')}. Proceed?`)) return;

            log("--- STEP 1: Deleting Selected Files Permanently ---");
            document.getElementById('btn-delete').disabled = true;

            fetch(API_DELETE_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    folders: checkedFolders,
                    user_dir: KALI_USER_DIR 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 200) {
                    log("✅ SUCCESS: Files marked for deletion (residue created).");
                    log("Data residue remains! Now proceed to Step 2 to wipe free space.");
                    document.getElementById('btn-certify').disabled = false;
                } else {
                    log(`❌ FAILURE: Deletion failed. Details: ${data.error}`);
                    document.getElementById('btn-delete').disabled = false;
                }
            })
            .catch(error => {
                log(`❌ CRITICAL ERROR: Could not connect to API for deletion. ${error}`);
                document.getElementById('btn-delete').disabled = false;
            });
        }


        // --- STEP 2: WIPE FREE SPACE & MINT PASSPORT (Functional API Call) ---
        function step2_wipeFreeSpace() {
            if (!confirm("CRITICAL WARNING: This overwrites ALL data residue on the drive. IRREVERSIBLE. Proceed?")) return;
            
            log("\n--- STEP 2: Certifying Wipe & Minting Passport ---");
            document.getElementById('btn-certify').disabled = true;

            const driveId = document.getElementById('drive-select').value;
            const algorithm = document.getElementById('algo-select').value;

            log(`Wiping Drive: ${driveId} using ${algorithm}`);
            log("⏳ Executing secure wipe via Django API. This may take a minute...");

            fetch(API_MINT_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    device_id: DEVICE_ID,
                    target_drive: driveId,
                    algorithm: algorithm,
                    user_dir: KALI_USER_DIR,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 201) {
                    log(`\n✅ CERTIFIED: Digital Passport Minted!`);
                    log(`Drive: ${driveId} is now clean.`);
                    log(`Algorithm Used: ${WIPE_ALGORITHMS[algorithm].name}`);
                    log(`DLT Hash: ${data.passport_hash}`);
                    log(`\n-=-=- FINAL STEP: PROCEED TO OS FACTORY RESET -=-=-`);
                    log(`(View certificate: /api/v1/view/${data.imei}/)`);
                } else {
                    log(`\n❌ FAILURE: API rejected. Details: ${data.detail || data.error}`);
                    document.getElementById('btn-certify').disabled = false;
                }
            })
            .catch(error => {
                log(`\n❌ CRITICAL ERROR: Could not communicate with Django API.`);
                document.getElementById('btn-certify').disabled = false;
            });
        }
    </script>
</body>
</html>